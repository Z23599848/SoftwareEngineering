<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lab week 11: Passwords and authentication | Roehampton</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Lab week 11: Passwords and authentication" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hosts module content for computing at Roehampton." />
<meta property="og:description" content="Hosts module content for computing at Roehampton." />
<link rel="canonical" href="https://roehampton.github.io/module-content/msc-software-development-2/week-11/lab/" />
<meta property="og:url" content="https://roehampton.github.io/module-content/msc-software-development-2/week-11/lab/" />
<meta property="og:site_name" content="Roehampton" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab week 11: Passwords and authentication" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Hosts module content for computing at Roehampton.","headline":"Lab week 11: Passwords and authentication","url":"https://roehampton.github.io/module-content/msc-software-development-2/week-11/lab/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/module-content/assets/css/style.css?v=ea56b5ca3cc64b80129c924758c62c92b98b36d5">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/module-content/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      

      <h1 id="lab-week-11-passwords-and-authentication">Lab week 11: Passwords and authentication</h1>

<p>In this lab we will look at how users can log in to your site and how, via ‘sessions’, you can securely personalise data users see and update.
There is a screencast for this lab: <a href="https://roehampton.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=33ea7950-de72-4a46-8b27-adf301306b1c">https://roehampton.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=33ea7950-de72-4a46-8b27-adf301306b1c</a></p>

<h2 id="user-stories">User stories</h2>

<p>As always, we need at least some specification before we start to code.</p>

<p>As a user I need to set a password matched with my email address so I can log in and see private and/or personalised information</p>

<p><strong>Tasks</strong></p>

<ul>
  <li>Install session and encryption libraries</li>
  <li>Create a table to hold user information with unique ids that can be be foreign keys to the Students table.</li>
  <li>Create a register form that can add new users and passwords to the table OR add a password to one of the existing users</li>
  <li>Create a login form using users email address and password</li>
  <li>Create backend code to set passwords for existing email addresses OR add to the Users table if the email address is new</li>
  <li>Create backend code to check a users’ login credentials entered in the login form</li>
  <li>Implement sessions so that successfully logged in users can have private and personalised information displayed to them</li>
  <li>Implement a logout link</li>
</ul>

<h2 id="getting-ready">Getting ready</h2>

<h4 id="add-libraries">Add libraries</h4>

<p>Stop your containers, run the following and then run docker-compose up –build</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install express-session
npm install bcryptjs
</code></pre></div></div>
<p>NOTE:  the bcryptjs library as opposed to the bcrypt library will work best with docker on different platforms.</p>

<h4 id="create-a-table-to-hold-user-information-with-unique-ids-that-can-be-be-foreign-keys-to-the-students-table">Create a table to hold user information with unique ids that can be be foreign keys to the Students table.</h4>

<p>Run the following SQL to set up a users table. Note the ‘auto increment’ - adding a new row will automatically generate a new ID, but that we are adding our existing Students with an ID that matches what is in the Students table.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`Users`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`email`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`password`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="c1">--</span>
<span class="c1">-- Dumping data for table `Users`</span>
<span class="c1">--</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`Users`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`email`</span><span class="p">,</span> <span class="nv">`password`</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'kevin@kevin.com'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'lisa@lisa.com'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'arturo@arturo.com'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'Sobham@sobhan.com'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>

<span class="c1">--</span>
<span class="c1">-- Indexes for table `Users`</span>
<span class="c1">--</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`Users`</span>
  <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">);</span>

<span class="c1">--</span>
<span class="c1">-- AUTO_INCREMENT for table `Users`</span>
<span class="c1">--</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`Users`</span>
  <span class="k">MODIFY</span> <span class="nv">`id`</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>

</code></pre></div></div>
<h2 id="development-tasks">Development tasks</h2>

<h3 id="create-templates-and-routes-for-your-login-and-register-forms">Create templates and routes for your login and register forms</h3>

<p>Create a new file <code class="language-plaintext highlighter-rouge">register.pug</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extends layout
block content
    h1 Register here
    form(action='/set-password' method='POST')
        label(for='email') Enter your email: 
        input(name='email') 
        label(for='email') Enter your password: 
        input(name='password' type = 'password')
        input(type='submit' value='Submit')

</code></pre></div></div>

<p>Create a new file <code class="language-plaintext highlighter-rouge">login.pug</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extends layout
block content
    h1 Login here
    form(action='/authenticate' method='POST')
        label(for='email') Enter your email: 
        input(name='email') 
        label(for='email') Enter your password: 
        input(name='password' type = 'password')
        input(type='submit' value='Submit')

</code></pre></div></div>

<p>Create routes for these in <code class="language-plaintext highlighter-rouge">app.js</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Register
app.get('/register', function (req, res) {
    res.render('register');
});

// Login
app.get('/login', function (req, res) {
    res.render('login');
});

</code></pre></div></div>

<h3 id="add-a-user-model-with-stubs-for-the-methods-we-will-need">Add a user model with stubs for the methods we will need</h3>

<p>Add a new file in the models directory <code class="language-plaintext highlighter-rouge">/models/user.js</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Get the functions in the db.js file to use
const db = require('../services/db');

class User {

    // Id of the user
    id;

    // Email of the user
    email;

    constructor(email) {
        this.email = email;
    }
    
    // Get an existing user id from an email address, or return false if not found
    async getIdFromEmail()  {
    
    }

    // Add a password to an existing user
    async setUserPassword(password) {

    }
    
    // Add a new record to the users table    
    async addUser(password) {
    
    }

    // Test a submitted password against a stored password
    async authenticate(submitted) {

    }


}

module.exports  = {
    User
}
</code></pre></div></div>

<p>Require this in the app.js file  (add near the top)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const { User } = require("./models/user");
</code></pre></div></div>

<h3 id="add-a-method-to-test-the-email-submitted-to-see-if-it-has-a-valid-id">Add a method to test the email submitted to see if it has a valid ID</h3>

<p>In your <code class="language-plaintext highlighter-rouge">user.js</code> file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// Checks to see if the submitted email address exists in the Users table</span>
<span class="k">async</span> <span class="nx">getIdFromEmail</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">SELECT id FROM Users WHERE Users.email = ?</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">]);</span>
        <span class="c1">// TODO LOTS OF ERROR CHECKS HERE..</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">!=</span> <span class="dl">'</span><span class="s1">[]</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<h3 id="add-a-method-to-hash-and-store-a-password-for-an-existing-user">Add a method to hash and store a password for an existing user</h3>

<p>Add this to the top of user.js. This provides us with tools to encrypt and compare passwords.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const bcrypt = require("bcryptjs");

</code></pre></div></div>

<p>And then this method:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">async</span> <span class="nx">setUserPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">pw</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">UPDATE Users SET password = ? WHERE Users.id = ?</span><span class="dl">"</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="nx">pw</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

</code></pre></div></div>
<p>Reference: https://www.npmjs.com/package/bcryptjs</p>

<h3 id="add-a-method-to-hash-and-store-the-password-and-submitted-email-address-for-a-new-user">Add a method to hash and store the password and submitted email address for a new user</h3>

<p>Also in user.js</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="c1">// Add a new record to the users table</span>
    <span class="k">async</span> <span class="nx">addUser</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">pw</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">INSERT INTO Users (email, password) VALUES (? , ?)</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">pw</span><span class="p">]);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">insertId</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

</code></pre></div></div>

<h3 id="get-data-from-the-register-form-and-update-or-create-user-records-in-the-backend">Get data from the register form and update or create user records in the backend</h3>

<p>Add the following to app.js. 
This provides a POST route which will first check for a valid user and then add the password to an existing record if there is one (This is needed at this point only because we have email addresses in the database with now password set yet).  If no existing user is found, a new record willb e created.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/set-password</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">uId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getIdFromEmail</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">uId</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If a valid, existing user is found, set the password and redirect to the users single-student page</span>
            <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">setUserPassword</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Password set successfully</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// If no existing user is found, add a new one</span>
            <span class="nx">newId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Perhaps a page where a new user sets a programme would be good here</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Error while adding password `</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="implement-the-authenticate-method">Implement the authenticate method</h3>

<p>in user.js</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Test a submitted password against a stored password</span>
<span class="k">async</span> <span class="nx">authenticate</span><span class="p">(</span><span class="nx">submitted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get the stored, hashed password for the user</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">SELECT password FROM Users WHERE id = ?</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
        <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">submitted</span><span class="p">,</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">password</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>in app.js, ass a post route which takes the form input, compares the password and redirects or shows an error message accordingly.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Check submitted email and password pair</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/authenticate</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">uId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getIdFromEmail</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">uId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/single-student/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">uId</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// TODO improve the user journey here</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">invalid password</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">invalid email</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Error while comparing `</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

</code></pre></div></div>

<h3 id="use-sessions-to-allow-our-app-to-know-if-a-user-is-logged-in-and-their-id">Use sessions to allow our app to know if a user is logged in and their id</h3>

<p>Add near the top of app.js</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Set the sessions</span>
<span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express-session</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="na">secret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">secretkeysdfjsflyoifasd</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">resave</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">saveUninitialized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">cookie</span><span class="p">:</span> <span class="p">{</span> <span class="na">secure</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span>
<span class="p">}));</span>

</code></pre></div></div>

<p>Go back to the authenticate route, and add the following two lines in the code block that executes if a match is found.  This is how you set the session.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uId</span><span class="p">;</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">loggedIn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="c1">// OPTIONAL: examine the session in the console</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

</code></pre></div></div>
<p>The entire authenticate route code should look like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Check submitted email and password pair</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/authenticate</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">uId</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getIdFromEmail</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">uId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">uid</span> <span class="o">=</span> <span class="nx">uId</span><span class="p">;</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">loggedIn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/student-single/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">uId</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// TODO improve the user journey here</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">invalid password</span><span class="dl">'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">invalid email</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">`Error while comparing `</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>


</code></pre></div></div>

<p>Write some code in app.js root route to test if the user is logged in, but seeing if the session is set as expected:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// Create a route for root - /</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Welcome back, </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">uid</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">!</span><span class="dl">'</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Please login to view this page!</span><span class="dl">'</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="logout">Logout</h3>

<p>add to app.js</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Logout
app.get('/logout', function (req, res) {
    req.session.destroy();
    res.redirect('/login');
  });
  
</code></pre></div></div>

<h2 id="exercise">EXERCISE:</h2>

<p>Create a personalised welcome page for a user.  Do  not include the user id in the route.  Instead, use the session object to test if the user is logged in and retrieve the ID.  HINT:  use <code class="language-plaintext highlighter-rouge">req.session.uid</code> to get the id and <code class="language-plaintext highlighter-rouge">req.session.loggedIn</code> to get the logged in status.</p>

<p>Note that you can add extra values to the session that may help you to build your app, typically for example a users role would be stored.</p>

<h2 id="extra-resources">Extra resources:</h2>

<p>Hashing and salting passwords:
https://auth0.com/blog/hashing-in-action-understanding-bcrypt/</p>

<p>Sessions and cookies:
https://www.section.io/engineering-education/session-management-in-nodejs-using-expressjs-and-express-session/</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
